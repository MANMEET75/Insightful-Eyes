<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insightful-Eyes</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=auvTMQpf"></script>
    <link href="../static/eyesIco.png" rel="icon">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://kit.fontawesome.com/afcb52252c.js" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <h1>Insightful-Eyes</h1>
    <form action="/ImageOverview" method="post" enctype="multipart/form-data" id="imageForm">
        <label for="upload">Upload Image</label>
        <input type="file" class="btn btn-dark" name="image_file" accept="image/*" id="imageFile" onchange="displayImage(this)"><br><br>
        
        <button type="button" onclick="captureFromWebcam()" class="btn btn-dark">Capture Image from Webcam</button>
        <br>
        <br>
        <div id="webcamPreview">
            <video id="webcam" autoplay></video>
            <button type="button" id="snap" onclick="snapPhoto()" class="btn btn-dark">Snap Photo</button>
        </div>
        <canvas id="canvas" style="display: none;"></canvas>

        <div id="imagePreview"></div>
        <br>
        <br>
        <input type="text" name="prompt" placeholder="Speak or type the prompt for the AI" id="prompt"><br><br>
        <button type="button" id="speakButton" onclick="startListening()" class="btn btn-dark">Speak Prompt</button>
        <button type="button" onclick="processImage()" class="btn btn-dark">Process Image</button>
        <br><br>
        <div id="response"></div>
        <div id="transcription"></div> <!-- Display transcription -->
    </form>
    <script>
        let videoStream = null;

        // Function to display the selected image
        function displayImage(input) {
            var preview = document.getElementById('imagePreview');
            while (preview.firstChild) {
                preview.removeChild(preview.firstChild);
            }
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    preview.appendChild(img);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Function to start listening for speech input
        function startListening() {
            var recognition = new webkitSpeechRecognition() || new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.onresult = function(event) {
                var transcript = event.results[0][0].transcript;
                document.getElementById('prompt').value = transcript;
                document.getElementById('transcription').textContent = transcript; // Display transcription
            };
            recognition.start();
        }

        // Function to send image to server for processing
        function processImage() {
            var form = document.getElementById('imageForm');
            var formData = new FormData(form);
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/ImageOverview", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var jsonResponse = JSON.parse(xhr.responseText);
                    var responseText = jsonResponse.response_text.replace('>', ''); // Remove ">" symbol
                    var responseContainer = document.getElementById('response');
                    responseContainer.textContent = responseText;
                    speak(responseText); // Speak the final response
                }
            };
            xhr.send(formData);
        }

        // Function to speak text with a female American accent and flirty voice
        function speak(text) {
            var utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = getFemaleFlirtyVoice();
            utterance.pitch = 3.5; // Adjust pitch to make it sound flirty
            utterance.rate = 0.9; // Adjust rate to control speaking speed
            window.speechSynthesis.speak(utterance);
        }

        // Function to get a female American accent voice with a flirty tone
        function getFemaleFlirtyVoice() {
            var voices = window.speechSynthesis.getVoices();
            for (var i = 0; i < voices.length; i++) {
                if (voices[i].lang === 'en-US' && voices[i].name.includes('English (United States)') && voices[i].name.includes('Female')) {
                    return voices[i];
                }
            }
            // If suitable voice is not found, return the default voice
            return null;
        }

        // Wait until voices are loaded before using the speech synthesis
        window.speechSynthesis.onvoiceschanged = function() {
            // This event is triggered when the voices are loaded
        };

        // Function to capture image from webcam
        function captureFromWebcam() {
            var video = document.getElementById('webcam');
            var webcamPreview = document.getElementById('webcamPreview');
            webcamPreview.style.display = 'block';

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.play();
                })
                .catch(function(err) {
                    console.log("An error occurred: " + err);
                });
        }

        // Function to snap photo from video feed
        function snapPhoto() {
            var video = document.getElementById('webcam');
            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');
            var webcamPreview = document.getElementById('webcamPreview');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            var img = new Image();
            img.src = canvas.toDataURL('image/png');
            img.style.maxWidth = '100%';
            img.style.height = 'auto';

            var preview = document.getElementById('imagePreview');
            while (preview.firstChild) {
                preview.removeChild(preview.firstChild);
            }
            preview.appendChild(img);

            // Convert canvas to Blob and append to form data
            canvas.toBlob(function(blob) {
                var file = new File([blob], "webcam_image.png", { type: "image/png" });
                var dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('imageFile').files = dataTransfer.files;
            });

            // Stop the video stream and hide the video element
            video.pause();
            video.srcObject = null;
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            webcamPreview.style.display = 'none';
        }
    </script>
</body>
</html>
